global
    log stdout format raw local0
    stats socket /tmp/haproxy/haproxy.sock mode 600 level admin

defaults
    log             global
    mode            tcp
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    retries         2                      # 연결 실패 시 최대 2회 재시도
    option redispatch                       # 첫 시도 실패 시 다른 서버로 재배치
    retry-on        conn-failure empty-response response-timeout

frontend amqp_global
    bind *:5672
    mode tcp
    option tcplog
    default_backend rabbit_cluster

backend rabbit_cluster
    mode    tcp
    balance roundrobin                     # 또는 leastconn
    option  tcp-check
    server  rabbit1 rabbit1:5672 check inter 1s fall 2 rise 1
    server  rabbit2 rabbit2:5672 check inter 1s fall 2 rise 1
    server  rabbit3 rabbit3:5672 check inter 1s fall 2 rise 1

# =================================================================
# RabbitMQ Management UI 트래픽 (포트 15672) - 신규 추가 (순차 접속)
# =================================================================

frontend rabbitmq_mgmt_ui
    bind *:15672
    mode http                                   # <-- 다시 http 모드로 변경!
    default_backend rabbit_mgmt_cluster

backend rabbit_mgmt_cluster
    mode    http                                # <-- 다시 http 모드로 변경!
    balance first
    # Basic 인증 헤더가 포함된, 올바른 HTTP 헬스체크 사용
    # 'guest:guest'를 Base64 인코딩한 'Z3Vlc3Q6Z3Vlc3Q=' 사용
    option httpchk GET /api/aliveness-test/%2f HTTP/1.1\r\nHost:\ localhost\r\nAuthorization:\ Basic\ Z3Vlc3Q6Z3Vlc3Q=

    # 서버 목록은 그대로
    server  rabbit1 rabbit1:15672 check inter 1s fall 2 rise 1
    server  rabbit2 rabbit2:15672 check inter 1s fall 2 rise 1 backup
    server  rabbit3 rabbit3:15672 check inter 1s fall 2 rise 1 backup
