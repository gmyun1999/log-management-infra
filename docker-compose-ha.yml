version: "3.9"
services:
  haproxy:
    image: haproxy:2.4
    user: haproxy
    entrypoint: >
      sh -c "
        exec haproxy -f /usr/local/etc/haproxy/haproxy.cfg
      "
    depends_on:
      rabbit1:
        condition: service_healthy
      rabbit2:
        condition: service_healthy
      rabbit3:
        condition: service_healthy
    tmpfs:
      - /tmp/haproxy:mode=1777,size=16m   # â† í•µì‹¬
    volumes:
      # (â˜…) í˜¸ìŠ¤íŠ¸ì˜ cfg â†’ ì»¨í…Œì´ë„ˆ cfg
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "5672:5672"
      - "${EXTERNAL_RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
    networks:
      elk-net:
        aliases:
          - haproxy

  # â”€ RabbitMQ 3-node Quorum cluster â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  rabbit1:
    build:
      context: ./rabbitmq-cluster
      dockerfile: Dockerfile
    hostname: rabbit1
    container_name: rabbit1
    environment:
      - RABBITMQ_ERLANG_COOKIE=${RABBITMQ_ERLANG_COOKIE}
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
      - RABBITMQ_NODENAME=${RABBITMQ_NODENAME_PREFIX}rabbit1
    volumes:
      - ./rabbitmq-cluster/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./rabbitmq-cluster/data/rabbit1:/var/lib/rabbitmq/mnesia
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      elk-net:
        aliases:
          - rabbit1
  rabbit2:
    build:
      context: ./rabbitmq-cluster
      dockerfile: Dockerfile
    hostname: rabbit2
    container_name: rabbit2
    depends_on:
      rabbit1:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    environment:
      - RABBITMQ_ERLANG_COOKIE=${RABBITMQ_ERLANG_COOKIE}
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
      - RABBITMQ_NODENAME=${RABBITMQ_NODENAME_PREFIX}rabbit2
    volumes:
      - ./rabbitmq-cluster/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./rabbitmq-cluster/data/rabbit2:/var/lib/rabbitmq/mnesia
      
    entrypoint: >
      bash -c "
        rabbitmq-server -detached &&
        sleep 10 &&
        rabbitmqctl stop_app &&
        rabbitmqctl join_cluster ${RABBITMQ_NODENAME_PREFIX}rabbit1 &&
        rabbitmqctl start_app &&
        tail -f /dev/null
      "
    networks:
      elk-net:
        aliases:
          - rabbit2
          
  rabbit3:
    build:
      context: ./rabbitmq-cluster
      dockerfile: Dockerfile
    hostname: rabbit3
    container_name: rabbit3
    depends_on:
      rabbit1:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    environment:
      - RABBITMQ_ERLANG_COOKIE=${RABBITMQ_ERLANG_COOKIE}
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
      - RABBITMQ_NODENAME=${RABBITMQ_NODENAME_PREFIX}rabbit3
    volumes:
      - ./rabbitmq-cluster/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./rabbitmq-cluster/data/rabbit3:/var/lib/rabbitmq/mnesia
    entrypoint: >
      bash -c "
        rabbitmq-server -detached &&
        sleep 10 &&
        rabbitmqctl stop_app &&
        rabbitmqctl join_cluster ${RABBITMQ_NODENAME_PREFIX}rabbit1 &&
        rabbitmqctl start_app &&
        tail -f /dev/null
      "
    networks:
      elk-net:
        aliases:
          - rabbit3

  rabbit-final:
    image: curlimages/curl:7.85.0
    depends_on:
      rabbit1:
        condition: service_healthy
      rabbit2:
        condition: service_healthy
      rabbit3:
        condition: service_healthy
    volumes:
      - ./rabbitmq-cluster/definitions.json:/definitions.json:ro
    entrypoint: >
      sh -c '
        set -eu
        USER=$${RABBITMQ_DEFAULT_USER:-guest}
        PASS=$${RABBITMQ_DEFAULT_PASS:-guest}
        HOST="rabbit1:15672"

        echo "$$(date) â³  waiting for rabbit1/2/3 to joinâ€¦"
        while :; do
          json=$$(curl -s -u "$$USER:$$PASS" "http://$$HOST/api/nodes" || true)

          echo "$$json" | grep -q "\"name\":\"rabbit@rabbit1\"" || { sleep 5; continue; }
          echo "$$json" | grep -q "\"name\":\"rabbit@rabbit2\"" || { sleep 5; continue; }
          echo "$$json" | grep -q "\"name\":\"rabbit@rabbit3\"" || { sleep 5; continue; }

          break
        done

        echo "Waiting for 60 seconds...."
        sleep 60

        echo "$$(date) âœ…  cluster ready. importing definitionsâ€¦"
        curl -sS -u "$$USER:$$PASS" -H "Content-Type: application/json" \
            -X POST --data-binary @/definitions.json \
            "http://$$HOST/api/definitions"
        echo "$$(date) ğŸ‰  done."
      '
    networks:
      - elk-net

  # â”€ Elasticsearch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.4
    mem_limit: "8g"
    container_name: log_elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    healthcheck:
      disable: true
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks:
      - elk-net

  es-init:
    image: curlimages/curl:7.85.0
    container_name: es-init
    depends_on:
      - elasticsearch
    entrypoint: >
      sh -c '
        echo "Waiting for Elasticsearch HTTP portâ€¦";
        until curl -sf http://elasticsearch:9200; do
          sleep 5;
        done;

        echo "Waiting for built-in ecs@mappings component templateâ€¦";
        # @ëŠ” %40ìœ¼ë¡œ ì¸ì½”ë”©í•´ì•¼ ì •í™•íˆ ê°ì§€ë©ë‹ˆë‹¤
        until curl -sf http://elasticsearch:9200/_component_template/ecs%40mappings; do
          sleep 5;
        done;

        echo "All prerequisites met â€“ loading logs-default index templateâ€¦";

        if response=$$(curl --fail-with-body -sS -X PUT \
             "http://elasticsearch:9200/_index_template/logs-default" \
             -H "Content-Type: application/json" \
             --data "@/templates/logs-default.json"); then
          echo "âœ… Index template loaded.";
        else
          echo "âŒ Failed to load index template:" >&2;
          echo "$$response" >&2;
          exit 1;
        fi
      '
    volumes:
      - ./es/templates/logs-default.json:/templates/logs-default.json:ro
    networks:
      - elk-net

  # â”€ Logstash 4 instances â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  logstash1:
    image: docker.elastic.co/logstash/logstash:8.13.4
    container_name: logstash1
    depends_on:
      - rabbit1
      - rabbit2
      - rabbit3
      - es-init
    volumes:
      - ./logstash/pipeline1:/usr/share/logstash/pipeline
      - ./wait-for-it.sh:/usr/local/bin/wait-for-it.sh
    entrypoint: >
      bash -c "
        # 1) ES ì¤€ë¹„ ëŒ€ê¸°
        /usr/local/bin/wait-for-it.sh elasticsearch:9200 --strict --timeout=120 &&
        # 2) RabbitMQ ì¤€ë¹„ ëŒ€ê¸°
        /usr/local/bin/wait-for-it.sh haproxy:5672 --strict --timeout=60 &&
        # 3) ì¤€ë¹„ë˜ë©´ Logstash ì§„ì§œ ì§„ì…ì  ì‹¤í–‰
        exec /usr/local/bin/docker-entrypoint
      "
    networks:
      - elk-net

  logstash2:
    image: docker.elastic.co/logstash/logstash:8.13.4
    container_name: logstash2
    depends_on:
      - rabbit1
      - rabbit2
      - rabbit3
      - es-init
    volumes:
      - ./logstash/pipeline2:/usr/share/logstash/pipeline
      - ./wait-for-it.sh:/usr/local/bin/wait-for-it.sh
    entrypoint: >
      bash -c "
        # 1) ES ì¤€ë¹„ ëŒ€ê¸°
        /usr/local/bin/wait-for-it.sh elasticsearch:9200 --strict --timeout=120 &&
        # 2) RabbitMQ ì¤€ë¹„ ëŒ€ê¸°
        /usr/local/bin/wait-for-it.sh haproxy:5672 --strict --timeout=60 &&
        # 3) ì¤€ë¹„ë˜ë©´ Logstash ì§„ì§œ ì§„ì…ì  ì‹¤í–‰
        exec /usr/local/bin/docker-entrypoint
      "
    networks:
      - elk-net

  logstash3:
    image: docker.elastic.co/logstash/logstash:8.13.4
    container_name: logstash3
    depends_on:
      - rabbit1
      - rabbit2
      - rabbit3
      - es-init
    volumes:
      - ./logstash/pipeline3:/usr/share/logstash/pipeline
      - ./wait-for-it.sh:/usr/local/bin/wait-for-it.sh
    entrypoint: >
      bash -c "
        # 1) ES ì¤€ë¹„ ëŒ€ê¸°
        /usr/local/bin/wait-for-it.sh elasticsearch:9200 --strict --timeout=120 &&
        # 2) RabbitMQ ì¤€ë¹„ ëŒ€ê¸°
        /usr/local/bin/wait-for-it.sh haproxy:5672 --strict --timeout=60 &&
        # 3) ì¤€ë¹„ë˜ë©´ Logstash ì§„ì§œ ì§„ì…ì  ì‹¤í–‰
        exec /usr/local/bin/docker-entrypoint
      "
    networks:
      - elk-net

  grafana:
    image: grafana/grafana-oss:latest
    depends_on:
      - elasticsearch
    ports:
      - "${EXTERNAL_GRAFANA_PORT}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP="false" # ì¼ë°˜ ì‚¬ìš©ì ê°€ì… ê¸ˆì§€
      - GF_AUTH_ANONYMOUS_ENABLED="true" # ìµëª… ì¡°íšŒ í—ˆìš©

      # ìµëª… ì‚¬ìš©ì ì—­í•  ì¶”ê°€
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      # ì„ë² ë”© í—ˆìš© ì„¤ì • ì¶”ê°€
      - GF_SECURITY_ALLOW_EMBEDDING=true
      # X-Frame-Options í—¤ë” ì„¤ì • ì œê±°
      - GF_SECURITY_X_FRAME_OPTIONS=

    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/etc/grafana/dashboards
    networks:
      - elk-net
    restart: unless-stopped
  redis:
    image: redis:7.2
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: ["redis-server", "--save", "60", "1", "--loglevel", "warning"]
    networks:
      - elk-net

networks:
  elk-net:
    driver: bridge

volumes:
  grafana-data:
  redis-data:
  es-data:
